# パイロット成長と報酬システム

## 概要

このシステムは「戦うと強くなる」「戦うと金が貯まる」という基本的なゲームループを実現します。

## 機能

### 1. パイロットステータス管理

各プレイヤーには以下のステータスが管理されます：

- **Level (レベル)**: 初期値 1
- **EXP (経験値)**: 初期値 0
- **Credits (クレジット)**: 初期値 1000

### 2. 経験値とレベルアップ

#### 経験値テーブル

次のレベルに必要な経験値の計算式：

```
必要経験値 = 現在のレベル × 100
```

例：
- Lv.1 → Lv.2: 100 EXP 必要
- Lv.2 → Lv.3: 200 EXP 必要
- Lv.5 → Lv.6: 500 EXP 必要

#### レベルアップ処理

- 経験値が必要量に達するとレベルアップ
- 余剰経験値は次のレベルに繰り越し
- 一度に複数レベルアップも可能

### 3. 戦闘報酬

#### 基本報酬

| 結果 | 経験値 | クレジット |
|------|--------|-----------|
| 勝利 | +100   | +500      |
| 敗北 | +20    | +100      |

#### 撃墜ボーナス

敵機を撃墜するごとに追加報酬：

- 経験値: **+10 / 機**
- クレジット: **+50 / 機**

#### 報酬計算例

**勝利して3機撃墜した場合：**
```
経験値 = 100 (基本) + 3 × 10 (撃墜ボーナス) = 130 EXP
クレジット = 500 (基本) + 3 × 50 (撃墜ボーナス) = 650 CR
```

**敗北したが2機撃墜した場合：**
```
経験値 = 20 (基本) + 2 × 10 (撃墜ボーナス) = 40 EXP
クレジット = 100 (基本) + 2 × 50 (撃墜ボーナス) = 200 CR
```

## 実装詳細

### Backend

#### 1. データモデル (`Pilot`)

```python
class Pilot(SQLModel, table=True):
    id: UUID
    user_id: str  # Clerk User ID (一意)
    name: str
    level: int = 1
    exp: int = 0
    credits: int = 1000
    created_at: datetime
    updated_at: datetime
```

#### 2. PilotService

パイロット管理の中心的なサービスクラス：

- `get_or_create_pilot()`: パイロットの取得または作成
- `calculate_required_exp()`: 次のレベルに必要な経験値を計算
- `calculate_battle_rewards()`: 戦闘結果から報酬を計算
- `add_rewards()`: 報酬を付与してレベルアップ処理

#### 3. API エンドポイント

- `GET /api/pilots/me`: 現在のユーザーのパイロット情報取得

#### 4. バッチ処理統合

`run_batch.py` の `_process_room()` 関数で、戦闘終了後に自動的に報酬が付与されます：

1. 戦闘結果の判定（勝敗、撃墜数）
2. 報酬の計算
3. パイロットデータの更新
4. レベルアップのログ記録

### Frontend

#### 1. ヘッダー表示

`Header.tsx` でパイロットのステータスを常に表示：

```tsx
<div>Lv. {pilot.level}</div>
<div>Credits: {pilot.credits.toLocaleString()}</div>
```

#### 2. リザルト画面

戦闘終了後、獲得した報酬を表示：

- 獲得経験値
- 獲得クレジット
- レベルアップ通知（該当する場合）
- 累積ステータス

#### 3. API統合

- `usePilot()`: パイロット情報を自動取得・更新
- 戦闘終了後に自動的にパイロット情報を再取得

## データベースマイグレーション

新しい `pilots` テーブルを追加するマイグレーションが含まれています：

```bash
# マイグレーション実行
cd backend
alembic upgrade head
```

## 使用方法

### 即時シミュレーション

1. ログイン状態でミッションを選択
2. 「即時シミュレーション実行」をクリック
3. 戦闘結果と獲得報酬を確認
4. ヘッダーのステータスが自動更新される

### 定期バトル

1. ログイン後、エントリーボタンをクリック
2. バッチ処理が実行される（定期実行）
3. バトル結果と報酬が自動的に付与される
4. 次回ログイン時にヘッダーで更新されたステータスを確認

## テスト

### 単体テスト

`backend/tests/unit/test_pilot_service.py` に以下のテストが含まれています：

- 経験値計算のテスト
- 報酬計算のテスト（勝利/敗北、撃墜ボーナス）
- レベルアップロジックのテスト（単一/複数レベル）

### 実行方法

```bash
cd backend
pytest tests/unit/test_pilot_service.py -v
```

## 今後の拡張案

- スキルシステム（レベルに応じて解放）
- ショップ機能（クレジットで装備購入）
- デイリーボーナス
- ランキングシステム
- 称号システム
