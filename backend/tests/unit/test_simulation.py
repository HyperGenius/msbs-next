"""Tests for the battle simulation engine."""

import pytest

from app.engine.simulation import BattleSimulator
from app.models.models import MobileSuit, Vector3, Weapon


def create_test_player() -> MobileSuit:
    """Create a test player mobile suit."""
    return MobileSuit(
        name="Test Gundam",
        max_hp=100,
        current_hp=100,
        armor=10,
        mobility=2.0,
        position=Vector3(x=0, y=0, z=0),
        weapons=[
            Weapon(
                id="beam_rifle",
                name="Beam Rifle",
                power=30,
                range=500,
                accuracy=85,
            )
        ],
        side="PLAYER",
    )


def create_test_enemy(name: str, position: Vector3) -> MobileSuit:
    """Create a test enemy mobile suit."""
    return MobileSuit(
        name=name,
        max_hp=80,
        current_hp=80,
        armor=5,
        mobility=1.2,
        position=position,
        weapons=[
            Weapon(
                id="zaku_mg",
                name="Zaku Machine Gun",
                power=15,
                range=400,
                accuracy=70,
            )
        ],
        side="ENEMY",
    )


def test_simulator_initialization() -> None:
    """Test that simulator initializes correctly."""
    player = create_test_player()
    enemies = [
        create_test_enemy("Enemy 1", Vector3(x=500, y=0, z=0)),
        create_test_enemy("Enemy 2", Vector3(x=500, y=200, z=0)),
    ]

    sim = BattleSimulator(player, enemies)

    assert sim.player == player
    assert len(sim.enemies) == 2
    assert len(sim.units) == 3
    assert sim.turn == 0
    assert not sim.is_finished


def test_process_turn_order() -> None:
    """Test that units act in mobility order."""
    player = create_test_player()
    player.mobility = 1.0  # Lower mobility
    enemies = [
        create_test_enemy("Fast Enemy", Vector3(x=500, y=0, z=0)),
    ]
    enemies[0].mobility = 2.0  # Higher mobility

    sim = BattleSimulator(player, enemies)
    sim.process_turn()

    # First log should be from the faster unit (enemy in this case)
    # They might move or attack depending on distance
    assert len(sim.logs) > 0
    assert sim.turn == 1


def test_player_vs_enemies_victory() -> None:
    """Test that battle ends when all enemies are defeated."""
    player = create_test_player()
    # Make player very strong
    player.weapons[0].power = 200
    player.weapons[0].accuracy = 100

    enemies = [
        create_test_enemy("Weak Enemy", Vector3(x=100, y=0, z=0)),
    ]

    sim = BattleSimulator(player, enemies)

    # Run simulation
    max_turns = 50
    while not sim.is_finished and sim.turn < max_turns:
        sim.process_turn()

    # Player should win
    assert player.current_hp > 0
    assert enemies[0].current_hp == 0
    assert sim.is_finished


def test_player_defeat() -> None:
    """Test that battle ends when player is defeated."""
    player = create_test_player()
    player.max_hp = 10
    player.current_hp = 10
    player.armor = 0

    enemies = [
        create_test_enemy("Strong Enemy", Vector3(x=100, y=0, z=0)),
    ]
    # Make enemy very strong
    enemies[0].weapons[0].power = 200
    enemies[0].weapons[0].accuracy = 100

    sim = BattleSimulator(player, enemies)

    # Run simulation
    max_turns = 50
    while not sim.is_finished and sim.turn < max_turns:
        sim.process_turn()

    # Player should lose
    assert player.current_hp == 0
    assert sim.is_finished


def test_multiple_enemies() -> None:
    """Test battle with multiple enemies."""
    player = create_test_player()
    enemies = [
        create_test_enemy("Enemy 1", Vector3(x=500, y=-200, z=0)),
        create_test_enemy("Enemy 2", Vector3(x=500, y=0, z=0)),
        create_test_enemy("Enemy 3", Vector3(x=500, y=200, z=0)),
    ]

    sim = BattleSimulator(player, enemies)

    # Run simulation
    max_turns = 50
    while not sim.is_finished and sim.turn < max_turns:
        sim.process_turn()

    # Battle should finish one way or another
    # Either player wins or loses
    alive_enemies = sum(1 for e in enemies if e.current_hp > 0)
    if player.current_hp > 0:
        assert alive_enemies == 0
    else:
        assert player.current_hp == 0


def test_logs_generated() -> None:
    """Test that battle logs are generated."""
    player = create_test_player()
    enemies = [
        create_test_enemy("Enemy 1", Vector3(x=500, y=0, z=0)),
    ]

    sim = BattleSimulator(player, enemies)

    # Run a few turns
    for _ in range(5):
        if not sim.is_finished:
            sim.process_turn()

    # Should have some logs
    assert len(sim.logs) > 0
    # All logs should have turn numbers
    for log in sim.logs:
        assert log.turn > 0
        assert log.message != ""
